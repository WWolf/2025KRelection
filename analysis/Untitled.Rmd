---
title: "Analysis code example"
author: "Nobody"
date: "2025-06-03"
output: html_document
---

```{r}
library(tidyverse)
#install.packages("showtext")
#library(showtext)
library(extrafont)

# font_import()
#loadfonts()

# Initialize showtext
#showtext_auto()
theme_set(
  theme_bw()  + 
    theme(
      plot.title    = element_text(size=20, family="NanumBarunGothicBold"),
      plot.subtitle = element_text(size=15, family="NanumBarunGothic"),
      text          = element_text(size=15, family="NanumBarunGothic")
          )
  
)

election_theme <-
  theme(
    plot.title = element_text( size = 10, face="bold" ),
    plot.subtitle = element_text( size = 8 ),
    plot.caption = element_text( size = 8 ),
    axis.text = element_text( size = 8 ),
    axis.title = element_text( size = 10 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 8 ),
    axis.text.y = element_text( size = 8 ),
    strip.text = element_text( size = 10 )
  )

"%ni%" <- Negate("%in%")

```

```{r}
#!/usr/bin/env Rscript
# -*- coding: utf-8 -*-
# Simple Election Data Loader
# Loads batch scraped data from data/ directory and formats it properly

# Load required libraries
library(tidyverse)
library(readr)
library(lubridate)

# Function to load city codes mapping
load_city_codes <- function() {
  city_codes <- read_delim("../config/city_codes.txt", 
                          delim = "|", 
                          comment = "#", 
                          col_names = c("code", "name_korean", "name_english"),
                          show_col_types = FALSE)
  return(city_codes)
}

# Function to parse batch directory name to extract timestamps
parse_batch_directory <- function(dir_name) {
  # Pattern: nec_data_electionId_date_time
  parts <- str_split(dir_name, "_")[[1]]
  if (length(parts) >= 4) {
    election_id <- parts[3]
    date_part <- parts[4]
    time_part <- parts[5]
    
    # Convert to datetime
    batch_timestamp <- ymd_hms(paste0(
      str_sub(date_part, 1, 4), "-",
      str_sub(date_part, 5, 6), "-", 
      str_sub(date_part, 7, 8), " ",
      str_sub(time_part, 1, 2), ":",
      str_sub(time_part, 3, 4), ":",
      str_sub(time_part, 5, 6)
    ))
    
    return(list(
      election_id = election_id,
      batch_timestamp = batch_timestamp
    ))
  }
  return(NULL)
}

# Function to parse CSV filename
parse_csv_filename <- function(filename) {
  # Pattern: citycode_cityname_date_time.csv
  basename_file <- str_remove(basename(filename), "\\.csv$")
  parts <- str_split(basename_file, "_")[[1]]
  
  if (length(parts) >= 3) {
    city_code <- parts[1]
    city_name <- parts[2]
    date_part <- parts[3]
    time_part <- parts[4]
    
    # Convert to datetime
    file_timestamp <- ymd_hms(paste0(
      str_sub(date_part, 1, 4), "-",
      str_sub(date_part, 5, 6), "-", 
      str_sub(date_part, 7, 8), " ",
      str_sub(time_part, 1, 2), ":",
      str_sub(time_part, 3, 4), ":",
      str_sub(time_part, 5, 6)
    ))
    
    return(list(
      city_code = city_code,
      city_name = city_name,
      file_timestamp = file_timestamp
    ))
  }
  return(NULL)
}

# Main function to load all election data
load_all_election_data <- function(data_dir = "../data") {
  cat("ğŸš€ Loading election data from", data_dir, "\n")
  
  # Load city codes
  city_codes <- load_city_codes()
  cat("ğŸ“‹ Loaded", nrow(city_codes), "city codes\n")
  
  # Get all batch directories
  batch_dirs <- list.dirs(data_dir, recursive = FALSE)
  cat("ğŸ“ Found", length(batch_dirs), "batch directories\n")
  
  all_data <- list()
  
  for (batch_dir in batch_dirs) {
    cat("ğŸ“‚ Processing", basename(batch_dir), "\n")
    
    # Parse batch directory info
    batch_info <- parse_batch_directory(basename(batch_dir))
    if (is.null(batch_info)) {
      cat("âš ï¸  Could not parse batch directory:", basename(batch_dir), "\n")
      next
    }
    
    # Find all CSV files in this batch
    csv_files <- list.files(batch_dir, pattern = "\\.csv$", full.names = TRUE)
    
    for (csv_file in csv_files) {
      # Parse filename
      file_info <- parse_csv_filename(csv_file)
      if (is.null(file_info)) {
        cat("âš ï¸  Could not parse filename:", basename(csv_file), "\n")
        next
      }
      
      # Read CSV data
      tryCatch({
        df <- read_csv(csv_file, locale = locale(encoding = "UTF-8"), show_col_types = FALSE)
        
        # Process based on whether it's ì „ì²´ (total) or city-specific
        if (file_info$city_code == "0" && file_info$city_name == "ì „ì²´") {
          # For ì „ì²´ files: District becomes City, add District = "ì „ì²´"
          df <- df %>%
            rename(City = District) %>%
            mutate(District = "ì „ì²´")
        } else {
          # For city-specific files: add City column from city codes
          city_info <- city_codes %>% filter(code == file_info$city_code)
          if (nrow(city_info) > 0) {
            df <- df %>%
              mutate(City = city_info$name_korean[1])
          } else {
            # Fallback to the parsed city name from filename
            df <- df %>%
              mutate(City = file_info$city_name)
          }
        }
        
        # Add metadata columns
        df <- df %>%
          mutate(
            city_code = file_info$city_code,
            batch_timestamp = batch_info$batch_timestamp,
            file_timestamp = file_info$file_timestamp,
            election_id = batch_info$election_id
          )
        
        # Reorder columns to put metadata first
        df <- df %>%
          select(election_id, city_code, City, District, batch_timestamp, file_timestamp, everything())
        
        all_data[[length(all_data) + 1]] <- df
        
      }, error = function(e) {
        cat("âŒ Error reading", basename(csv_file), ":", e$message, "\n")
      })
    }
  }
  
  # Combine all data
  if (length(all_data) > 0) {
    combined_data <- bind_rows(all_data)
    cat("âœ… Successfully loaded", nrow(combined_data), "rows from", length(all_data), "files\n")
    cat("ğŸ“Š Data range:", min(combined_data$batch_timestamp), "to", max(combined_data$batch_timestamp), "\n")
    cat("ğŸ™ï¸  Cities:", length(unique(combined_data$City)), "\n")
    
    return(combined_data)
  } else {
    cat("âŒ No data loaded\n")
    return(NULL)
  }
}

# Example usage:
# Load all data
# election_data <- load_all_election_data()

# View structure
# glimpse(election_data)

# Check unique cities
# election_data %>% distinct(City, city_code) %>% arrange(city_code)

# Check data types by city
# election_data %>% count(City, District) %>% arrange(City)
```

```{r}
# Load all data
election_data <- load_all_election_data()

# View the structure
glimpse(election_data)

# Check what cities we have
election_data %>% distinct(City, city_code) %>% arrange(city_code)

# See the data types (total vs district-level)
election_data %>% count(City, District) %>% arrange(City)

```

```{r}
election_data$City %>% unique()
```

í›„ë³´ìë³„ ë“í‘œìˆ˜ í•©ê³„ì™€ ë¬´íš¨íˆ¬í‘œìˆ˜, ê¸°ê¶Œììˆ˜ê°€ ë½‘íˆì§€ ì•Šì•˜ë‹¤.........í•˜ì§€ë§Œ ê³„ì‚° ê°€ëŠ¥í•˜ë‹¤

```{r}
election_data %>% colnames()
```
# í›„ë³´ë³„ ë“í‘œìˆ˜, ë“í‘œìœ¨ ì¶”ì´

```{r}
election_data %>%
  dplyr::filter( city_code == 0 ) %>%
  group_by( city_code ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Votes") ) %>%
  dplyr::select( -Invalid_Votes, -Total_Votes ) %>%
  pivot_longer( cols = ends_with("_Votes"), names_to = "candidate", values_to = "Votes" ) %>%
  mutate(
    candidate = gsub("_Votes", "", candidate ),
    candidate2 = case_when(
      grepl("ì´ì¬ëª…", candidate) ~ "ì´ì¬ëª…",
      grepl("ê¹€ë¬¸ìˆ˜", candidate) ~ "ê¹€ë¬¸ìˆ˜",
      grepl("ì´ì¤€ì„", candidate) ~ "ì´ì¤€ì„",
      grepl("ê¶Œì˜êµ­", candidate) ~ "ê¶Œì˜êµ­",
      TRUE ~ "ê¸°íƒ€"
    ),
    candidate2 = factor( candidate2, levels = c("ì´ì¬ëª…", "ê¹€ë¬¸ìˆ˜", "ì´ì¤€ì„", "ê¶Œì˜êµ­", "ê¸°íƒ€")),
    City = factor( City, levels = c("ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
  ) %>%
  dplyr::filter( candidate2 != "ê¸°íƒ€", batch_timestamp != max(batch_timestamp) ) %>%
  ggplot( aes( x = file_timestamp, y = Votes/10000, colour = candidate2 ) ) +
  geom_line() +
  facet_wrap( City ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::comma ) +
  scale_colour_manual(
    values = c(
      "ì´ì¬ëª…" = "#1e4d9b",
      "ê¹€ë¬¸ìˆ˜" = "#e61e2b",
      "ì´ì¤€ì„" = "#ea5504",
      "ê¶Œì˜êµ­" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "ê°œí‘œì‹œ í›„ë³´ë³„ ë“í‘œìˆ˜ ë³€í™”",
    colour = "í›„ë³´",
    y = "ë§Œí‘œ"
  )

```
```{r}
election_data %>%
  dplyr::filter( city_code == 0 ) %>%
  group_by( city_code ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Percentage") ) %>%
  pivot_longer( cols = ends_with("_Percentage"), names_to = "candidate", values_to = "Percent" ) %>%
  mutate(
    candidate = gsub("_Votes", "", candidate ),
    candidate2 = case_when(
      grepl("ì´ì¬ëª…", candidate) ~ "ì´ì¬ëª…",
      grepl("ê¹€ë¬¸ìˆ˜", candidate) ~ "ê¹€ë¬¸ìˆ˜",
      grepl("ì´ì¤€ì„", candidate) ~ "ì´ì¤€ì„",
      grepl("ê¶Œì˜êµ­", candidate) ~ "ê¶Œì˜êµ­",
      TRUE ~ "ê¸°íƒ€"
    ),
    candidate2 = factor( candidate2, levels = c("ì´ì¬ëª…", "ê¹€ë¬¸ìˆ˜", "ì´ì¤€ì„", "ê¶Œì˜êµ­", "ê¸°íƒ€")),
    City = factor( City, levels = c("ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
    
  ) %>%
  dplyr::filter( candidate2 != "ê¸°íƒ€", batch_timestamp != max(batch_timestamp) ) %>%
  ggplot( aes( x = file_timestamp, y = Percent/100, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( City ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::percent, expand = expansion( mult = c(0, 0.05 )) ) +
  scale_colour_manual(
    values = c(
      "ì´ì¬ëª…" = "#1e4d9b",
      "ê¹€ë¬¸ìˆ˜" = "#e61e2b",
      "ì´ì¤€ì„" = "#ea5504",
      "ê¶Œì˜êµ­" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "ê°œí‘œì‹œ í›„ë³´ë³„ ë“í‘œìœ¨ ë³€í™”",
    colour = "í›„ë³´",
#    y = "ë§Œí‘œ"
  )

```

# ì„ ê±°ì¸ìˆ˜, íˆ¬í‘œìˆ˜ ì •ë¦¬

`Eligible_Voters`ëŠ” ì„ ê±°ì¸ìˆ˜. `Total_Votes`ëŠ” íˆ¬í‘œìˆ˜.

```{r}
election_data %>%
  dplyr::filter( batch_timestamp == max(batch_timestamp) ) %>%
  dplyr::select( !ends_with("_Percentage" ) ) %>%
  dplyr::select( !ends_with("_timestamp") ) %>%
  mutate(
    ê¸°ê¶Œììˆ˜ = Eligible_Voters - Total_Votes
  )
```

ê·¸ëŸ°ë° ì´ê²Œ ì²˜ìŒì—ëŠ” ì„ ê±°ì¸ìˆ˜ë‘ íˆ¬í‘œìˆ˜ ìì²´ê°€ ë³€í•´ë²„ë¦¬ëŠ” ë¬¸ì œê°€ ìˆë‹¤.

```{r}
election_data %>%
  dplyr::filter( city_code == 0 ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  group_by(
    election_id, city_code, City, District
  ) %>%
  dplyr::select( file_timestamp, City, Total_Votes, Eligible_Voters ) %>%
  mutate(
    City = factor( City, levels = c("ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„"))
  ) %>% 
  pivot_longer( cols = contains("_Vote"), names_to = "ì¹¼ëŸ¼", values_to = "n" ) %>%
  ggplot( aes( x = file_timestamp, y = n, colour = City ) ) +
  geom_line() +
  scale_y_continuous( label = scales::comma ) +
  facet_wrap( . ~ ì¹¼ëŸ¼ ) +
  theme(
    text = element_text( size = 15 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1 )
  )
```
ê°œí‘œìœ¨ê³¼ ê¸°ê¶Œí‘œë¥¼ ë‹¤ì‹œ ê³„ì‚°í•˜ê¸° ìœ„í•´ì„œë¼ë©´ ì´ ì„ ê±°ì¸ìˆ˜ì™€ íˆ¬í‘œìˆ˜ë¥¼ ìˆ˜ì •í•´ì•¼í•œë‹¤.


# ë°ì´í„° ì •ë¦¬

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "ì „ì²´", "ì „ì²´", City ),
    District2 = ifelse( District == "ì „ì²´", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("ì „ì²´", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ì„ ê±°ì¸ìˆ˜` = max( Eligible_Voters ),
    `íˆ¬í‘œìˆ˜` = max( Total_Votes ),
    Abstentions = ì„ ê±°ì¸ìˆ˜ - Total_Votes,
    Invalid_Votes = Total_Votes 
      - ë¬´ì†Œì†ì†¡ì§„í˜¸_Votes 
      - ë¯¼ì£¼ë…¸ë™ë‹¹ê¶Œì˜êµ­_Votes 
      - ê°œí˜ì‹ ë‹¹ì´ì¤€ì„_Votes 
      - êµ­ë¯¼ì˜í˜ê¹€ë¬¸ìˆ˜_Votes
      - ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ì´ì¬ëª…_Votes,
    Counting_Rate = Total_Votes / íˆ¬í‘œìˆ˜,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  write_tsv("../processed/ê°œí‘œì§„í–‰ìƒí™©.tsv")
```


# ê°œí‘œìœ¨ ì¶”ì´

## ì „ì²´ (ê´‘ì—­ë³„)

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "ì „ì²´", "ì „ì²´", City ),
    District2 = ifelse( District == "ì „ì²´", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("ì „ì²´", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ì„ ê±°ì¸ìˆ˜` = max( Eligible_Voters ),
    `íˆ¬í‘œìˆ˜` = max( Total_Votes ),
    Abstentions = ì„ ê±°ì¸ìˆ˜ - Total_Votes,
    Invalid_Votes = Total_Votes 
      - ë¬´ì†Œì†ì†¡ì§„í˜¸_Votes 
      - ë¯¼ì£¼ë…¸ë™ë‹¹ê¶Œì˜êµ­_Votes 
      - ê°œí˜ì‹ ë‹¹ì´ì¤€ì„_Votes 
      - êµ­ë¯¼ì˜í˜ê¹€ë¬¸ìˆ˜_Votes
      - ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ì´ì¬ëª…_Votes,
    Counting_Rate = Total_Votes / íˆ¬í‘œìˆ˜,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ì „ì²´" ) %>%
  mutate(
    District = factor( District, levels = c( "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  ) %>%
  ggplot( aes( x = file_timestamp, y = Counting_Rate, colour = District ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( expand = expansion( mult = c(0, 0) ), label = scales::percent ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    x = "í•œêµ­ ì‹œê°",
    y = "ê°œí‘œìœ¨(%)"
  )
```

## ì„œìš¸íŠ¹ë³„ì‹œ ì‚¬ë¡€

```{r}
election_data %>%
  dplyr::filter( city_code == 0 ) %>%
  group_by( city_code ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Percentage") ) %>%
  pivot_longer( cols = ends_with("_Percentage"), names_to = "candidate", values_to = "Percent" ) %>%
  mutate(
    candidate = gsub("_Votes", "", candidate ),
    candidate2 = case_when(
      grepl("ì´ì¬ëª…", candidate) ~ "ì´ì¬ëª…",
      grepl("ê¹€ë¬¸ìˆ˜", candidate) ~ "ê¹€ë¬¸ìˆ˜",
      grepl("ì´ì¤€ì„", candidate) ~ "ì´ì¤€ì„",
      grepl("ê¶Œì˜êµ­", candidate) ~ "ê¶Œì˜êµ­",
      TRUE ~ "ê¸°íƒ€"
    ),
    candidate2 = factor( candidate2, levels = c("ì´ì¬ëª…", "ê¹€ë¬¸ìˆ˜", "ì´ì¤€ì„", "ê¶Œì˜êµ­", "ê¸°íƒ€")),
    City = factor( City, levels = c("ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
    
  ) %>%
  dplyr::filter( candidate2 != "ê¸°íƒ€", batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ì„œìš¸íŠ¹ë³„ì‹œ" ) %>%
  ggplot( aes( x = file_timestamp, y = Percent/100, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( City ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::percent, expand = expansion( mult = c(0, 0.05 )) ) +
  scale_colour_manual(
    values = c(
      "ì´ì¬ëª…" = "#1e4d9b",
      "ê¹€ë¬¸ìˆ˜" = "#e61e2b",
      "ì´ì¤€ì„" = "#ea5504",
      "ê¶Œì˜êµ­" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "ê°œí‘œì‹œ í›„ë³´ë³„ ë“í‘œìœ¨ ë³€í™”",
    colour = "í›„ë³´",
    y = "ë“í‘œìœ¨(%)"
  )

```


```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "ì „ì²´", "ì „ì²´", City ),
    District2 = ifelse( District == "ì „ì²´", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("ì „ì²´", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ì„ ê±°ì¸ìˆ˜` = max( Eligible_Voters ),
    `íˆ¬í‘œìˆ˜` = max( Total_Votes ),
    Abstentions = ì„ ê±°ì¸ìˆ˜ - Total_Votes,
    Invalid_Votes = Total_Votes 
      - ë¬´ì†Œì†ì†¡ì§„í˜¸_Votes 
      - ë¯¼ì£¼ë…¸ë™ë‹¹ê¶Œì˜êµ­_Votes 
      - ê°œí˜ì‹ ë‹¹ì´ì¤€ì„_Votes 
      - êµ­ë¯¼ì˜í˜ê¹€ë¬¸ìˆ˜_Votes
      - ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ì´ì¬ëª…_Votes,
    Counting_Rate = Total_Votes / íˆ¬í‘œìˆ˜,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ì„œìš¸íŠ¹ë³„ì‹œ" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  # ) %>%
  ggplot( aes( x = file_timestamp, y = Counting_Rate, colour = District ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( expand = expansion( mult = c(0, 0) ), label = scales::percent ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "ê°œí‘œë‹¹ì‹œ êµ¬ë³„ ê°œí‘œìœ¨",
    subtitle = "ì„œìš¸íŠ¹ë³„ì‹œ",
    x = "í•œêµ­ ì‹œê°",
    y = "ê°œí‘œìœ¨(%)",
    caption = "ê´€ì™¸íˆ¬í‘œëŠ” ë§ˆì§€ë§‰ì— ì¶”ê°€ëœ ê²ƒìœ¼ë¡œ ë³´ì„"
  )
```

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "ì „ì²´", "ì „ì²´", City ),
    District2 = ifelse( District == "ì „ì²´", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("ì „ì²´", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ì„ ê±°ì¸ìˆ˜` = max( Eligible_Voters ),
    `íˆ¬í‘œìˆ˜` = max( Total_Votes ),
    Abstentions = ì„ ê±°ì¸ìˆ˜ - Total_Votes,
    Invalid_Votes = Total_Votes 
      - ë¬´ì†Œì†ì†¡ì§„í˜¸_Votes 
      - ë¯¼ì£¼ë…¸ë™ë‹¹ê¶Œì˜êµ­_Votes 
      - ê°œí˜ì‹ ë‹¹ì´ì¤€ì„_Votes 
      - êµ­ë¯¼ì˜í˜ê¹€ë¬¸ìˆ˜_Votes
      - ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ì´ì¬ëª…_Votes,
    Counting_Rate = Total_Votes / íˆ¬í‘œìˆ˜,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ì„œìš¸íŠ¹ë³„ì‹œ" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  # ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Percentage") ) %>%
  pivot_longer( 
    cols = ends_with("_Percentage"), 
    names_to = "candidate", 
    values_to = "Percent"
  ) %>%
  mutate(
    candidate2 = case_when(
      grepl("ì´ì¬ëª…", candidate) ~ "ì´ì¬ëª…",
      grepl("ê¹€ë¬¸ìˆ˜", candidate) ~ "ê¹€ë¬¸ìˆ˜",
      grepl("ì´ì¤€ì„", candidate) ~ "ì´ì¤€ì„",
      grepl("ê¶Œì˜êµ­", candidate) ~ "ê¶Œì˜êµ­",
      TRUE ~ "ê¸°íƒ€"
    ),
    candidate2 = factor( candidate2, levels = c("ì´ì¬ëª…", "ê¹€ë¬¸ìˆ˜", "ì´ì¤€ì„", "ê¶Œì˜êµ­", "ê¸°íƒ€"))
  ) %>%
  ggplot( aes( x = file_timestamp, y = Percent/100, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( District ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::percent, expand = expansion( mult = c(0, 0.05 )) ) +
  scale_colour_manual(
    values = c(
      "ì´ì¬ëª…" = "#1e4d9b",
      "ê¹€ë¬¸ìˆ˜" = "#e61e2b",
      "ì´ì¤€ì„" = "#ea5504",
      "ê¶Œì˜êµ­" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "ê°œí‘œì‹œ í›„ë³´ë³„ ë“í‘œìœ¨ ë³€í™”",
    subtitle = "ì„œìš¸íŠ¹ë³„ì‹œ",
    colour = "í›„ë³´",
    y = "ë“í‘œìœ¨(%)"
  )
```

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "ì „ì²´", "ì „ì²´", City ),
    District2 = ifelse( District == "ì „ì²´", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("ì „ì²´", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ì„ ê±°ì¸ìˆ˜` = max( Eligible_Voters ),
    `íˆ¬í‘œìˆ˜` = max( Total_Votes ),
    Abstentions = ì„ ê±°ì¸ìˆ˜ - Total_Votes,
    Invalid_Votes = Total_Votes 
      - ë¬´ì†Œì†ì†¡ì§„í˜¸_Votes 
      - ë¯¼ì£¼ë…¸ë™ë‹¹ê¶Œì˜êµ­_Votes 
      - ê°œí˜ì‹ ë‹¹ì´ì¤€ì„_Votes 
      - êµ­ë¯¼ì˜í˜ê¹€ë¬¸ìˆ˜_Votes
      - ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ì´ì¬ëª…_Votes,
    Counting_Rate = Total_Votes / íˆ¬í‘œìˆ˜,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ì„œìš¸íŠ¹ë³„ì‹œ" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  # ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Votes") ) %>%
  pivot_longer( 
    cols = ends_with("_Votes"), 
    names_to = "candidate", 
    values_to = "Votes"
  ) %>%
  mutate(
    candidate2 = case_when(
      grepl("ì´ì¬ëª…", candidate) ~ "ì´ì¬ëª…",
      grepl("ê¹€ë¬¸ìˆ˜", candidate) ~ "ê¹€ë¬¸ìˆ˜",
      grepl("ì´ì¤€ì„", candidate) ~ "ì´ì¤€ì„",
      grepl("ê¶Œì˜êµ­", candidate) ~ "ê¶Œì˜êµ­",
      TRUE ~ "ê¸°íƒ€"
    ),
    candidate2 = factor( candidate2, levels = c("ì´ì¬ëª…", "ê¹€ë¬¸ìˆ˜", "ì´ì¤€ì„", "ê¶Œì˜êµ­", "ê¸°íƒ€"))
  ) %>%
  dplyr::filter( candidate2 %ni% c("ê¸°íƒ€"), !is.na( candidate2) ) %>%
  ggplot( aes( x = file_timestamp, y = Votes, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( District ~ . ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( 
    label = scales::comma, 
    expand = expansion( mult = c(0, 0.05 )) 
  ) +
  scale_colour_manual(
    values = c(
      "ì´ì¬ëª…" = "#1e4d9b",
      "ê¹€ë¬¸ìˆ˜" = "#e61e2b",
      "ì´ì¤€ì„" = "#ea5504",
      "ê¶Œì˜êµ­" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "ê°œí‘œ ë‹¹ì‹œ í›„ë³´ë³„ ë“í‘œìˆ˜ ë³€í™”",
    subtitle = "ì„œìš¸íŠ¹ë³„ì‹œ",
    colour = "í›„ë³´",
    y = "ë“í‘œìˆ˜"
  )
```
## ìš¸ì‚°ê´‘ì—­ì‹œ ì‚¬ë¡€

```{r}
election_data %>%
  dplyr::filter( city_code == 0 ) %>%
  group_by( city_code ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Percentage") ) %>%
  pivot_longer( cols = ends_with("_Percentage"), names_to = "candidate", values_to = "Percent" ) %>%
  mutate(
    candidate = gsub("_Votes", "", candidate ),
    candidate2 = case_when(
      grepl("ì´ì¬ëª…", candidate) ~ "ì´ì¬ëª…",
      grepl("ê¹€ë¬¸ìˆ˜", candidate) ~ "ê¹€ë¬¸ìˆ˜",
      grepl("ì´ì¤€ì„", candidate) ~ "ì´ì¤€ì„",
      grepl("ê¶Œì˜êµ­", candidate) ~ "ê¶Œì˜êµ­",
      TRUE ~ "ê¸°íƒ€"
    ),
    candidate2 = factor( candidate2, levels = c("ì´ì¬ëª…", "ê¹€ë¬¸ìˆ˜", "ì´ì¤€ì„", "ê¶Œì˜êµ­", "ê¸°íƒ€")),
    City = factor( City, levels = c("ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
    
  ) %>%
  dplyr::filter( candidate2 != "ê¸°íƒ€", batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ìš¸ì‚°ê´‘ì—­ì‹œ" ) %>%
  ggplot( aes( x = file_timestamp, y = Percent/100, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( City ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::percent, expand = expansion( mult = c(0, 0.05 )) ) +
  scale_colour_manual(
    values = c(
      "ì´ì¬ëª…" = "#1e4d9b",
      "ê¹€ë¬¸ìˆ˜" = "#e61e2b",
      "ì´ì¤€ì„" = "#ea5504",
      "ê¶Œì˜êµ­" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "ê°œí‘œì‹œ í›„ë³´ë³„ ë“í‘œìœ¨ ë³€í™”",
    colour = "í›„ë³´",
#    y = "ë§Œí‘œ"
  )

```


```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "ì „ì²´", "ì „ì²´", City ),
    District2 = ifelse( District == "ì „ì²´", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("ì „ì²´", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ì„ ê±°ì¸ìˆ˜` = max( Eligible_Voters ),
    `íˆ¬í‘œìˆ˜` = max( Total_Votes ),
    Abstentions = ì„ ê±°ì¸ìˆ˜ - Total_Votes,
    Invalid_Votes = Total_Votes 
      - ë¬´ì†Œì†ì†¡ì§„í˜¸_Votes 
      - ë¯¼ì£¼ë…¸ë™ë‹¹ê¶Œì˜êµ­_Votes 
      - ê°œí˜ì‹ ë‹¹ì´ì¤€ì„_Votes 
      - êµ­ë¯¼ì˜í˜ê¹€ë¬¸ìˆ˜_Votes
      - ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ì´ì¬ëª…_Votes,
    Counting_Rate = Total_Votes / íˆ¬í‘œìˆ˜,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ìš¸ì‚°ê´‘ì—­ì‹œ" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  # ) %>%
  ggplot( aes( x = file_timestamp, y = Counting_Rate, colour = District ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( expand = expansion( mult = c(0, 0) ), label = scales::percent ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    x = "í•œêµ­ ì‹œê°",
    y = "ê°œí‘œìœ¨(%)"
  )
```

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "ì „ì²´", "ì „ì²´", City ),
    District2 = ifelse( District == "ì „ì²´", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("ì „ì²´", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ì„ ê±°ì¸ìˆ˜` = max( Eligible_Voters ),
    `íˆ¬í‘œìˆ˜` = max( Total_Votes ),
    Abstentions = ì„ ê±°ì¸ìˆ˜ - Total_Votes,
    Invalid_Votes = Total_Votes 
      - ë¬´ì†Œì†ì†¡ì§„í˜¸_Votes 
      - ë¯¼ì£¼ë…¸ë™ë‹¹ê¶Œì˜êµ­_Votes 
      - ê°œí˜ì‹ ë‹¹ì´ì¤€ì„_Votes 
      - êµ­ë¯¼ì˜í˜ê¹€ë¬¸ìˆ˜_Votes
      - ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ì´ì¬ëª…_Votes,
    Counting_Rate = Total_Votes / íˆ¬í‘œìˆ˜,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ìš¸ì‚°ê´‘ì—­ì‹œ" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  # ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Percentage") ) %>%
  pivot_longer( 
    cols = ends_with("_Percentage"), 
    names_to = "candidate", 
    values_to = "Percent"
  ) %>%
  mutate(
    candidate2 = case_when(
      grepl("ì´ì¬ëª…", candidate) ~ "ì´ì¬ëª…",
      grepl("ê¹€ë¬¸ìˆ˜", candidate) ~ "ê¹€ë¬¸ìˆ˜",
      grepl("ì´ì¤€ì„", candidate) ~ "ì´ì¤€ì„",
      grepl("ê¶Œì˜êµ­", candidate) ~ "ê¶Œì˜êµ­",
      TRUE ~ "ê¸°íƒ€"
    ),
    candidate2 = factor( candidate2, levels = c("ì´ì¬ëª…", "ê¹€ë¬¸ìˆ˜", "ì´ì¤€ì„", "ê¶Œì˜êµ­", "ê¸°íƒ€"))
  ) %>%
  ggplot( aes( x = file_timestamp, y = Percent/100, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( District ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::percent, expand = expansion( mult = c(0, 0.05 )) ) +
  scale_colour_manual(
    values = c(
      "ì´ì¬ëª…" = "#1e4d9b",
      "ê¹€ë¬¸ìˆ˜" = "#e61e2b",
      "ì´ì¤€ì„" = "#ea5504",
      "ê¶Œì˜êµ­" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "ê°œí‘œì‹œ í›„ë³´ë³„ ë“í‘œìœ¨ ë³€í™”",
    subtitle = "ìš¸ì‚°ê´‘ì—­ì‹œ",
    colour = "í›„ë³´",
    y = "ë“í‘œìœ¨(%)"
  )
```

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "ì „ì²´", "ì „ì²´", City ),
    District2 = ifelse( District == "ì „ì²´", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("ì „ì²´", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ì„ ê±°ì¸ìˆ˜` = max( Eligible_Voters ),
    `íˆ¬í‘œìˆ˜` = max( Total_Votes ),
    Abstentions = ì„ ê±°ì¸ìˆ˜ - Total_Votes,
    Invalid_Votes = Total_Votes 
      - ë¬´ì†Œì†ì†¡ì§„í˜¸_Votes 
      - ë¯¼ì£¼ë…¸ë™ë‹¹ê¶Œì˜êµ­_Votes 
      - ê°œí˜ì‹ ë‹¹ì´ì¤€ì„_Votes 
      - êµ­ë¯¼ì˜í˜ê¹€ë¬¸ìˆ˜_Votes
      - ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ì´ì¬ëª…_Votes,
    Counting_Rate = Total_Votes / íˆ¬í‘œìˆ˜,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ìš¸ì‚°ê´‘ì—­ì‹œ" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ê²½ê¸°ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë¼ë‚¨ë„", "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„")),
  # ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Votes") ) %>%
  pivot_longer( 
    cols = ends_with("_Votes"), 
    names_to = "candidate", 
    values_to = "Votes"
  ) %>%
  mutate(
    candidate2 = case_when(
      grepl("ì´ì¬ëª…", candidate) ~ "ì´ì¬ëª…",
      grepl("ê¹€ë¬¸ìˆ˜", candidate) ~ "ê¹€ë¬¸ìˆ˜",
      grepl("ì´ì¤€ì„", candidate) ~ "ì´ì¤€ì„",
      grepl("ê¶Œì˜êµ­", candidate) ~ "ê¶Œì˜êµ­",
      TRUE ~ "ê¸°íƒ€"
    ),
    candidate2 = factor( candidate2, levels = c("ì´ì¬ëª…", "ê¹€ë¬¸ìˆ˜", "ì´ì¤€ì„", "ê¶Œì˜êµ­", "ê¸°íƒ€"))
  ) %>%
  dplyr::filter( candidate2 %ni% c("ê¸°íƒ€"), !is.na( candidate2) ) %>%
  ggplot( aes( x = file_timestamp, y = Votes, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( District ~ . ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( 
    label = scales::comma, 
    expand = expansion( mult = c(0, 0.05 )) 
  ) +
  scale_colour_manual(
    values = c(
      "ì´ì¬ëª…" = "#1e4d9b",
      "ê¹€ë¬¸ìˆ˜" = "#e61e2b",
      "ì´ì¤€ì„" = "#ea5504",
      "ê¶Œì˜êµ­" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "ê°œí‘œ ë‹¹ì‹œ í›„ë³´ë³„ ë“í‘œìˆ˜ ë³€í™”",
    subtitle = "ìš¸ì‚°ê´‘ì—­ì‹œ",
    colour = "í›„ë³´",
    y = "ë“í‘œìˆ˜"
  )
```