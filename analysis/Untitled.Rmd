---
title: "Analysis code example"
author: "Nobody"
date: "2025-06-03"
output: html_document
---

```{r}
library(tidyverse)
#install.packages("showtext")
#library(showtext)
library(extrafont)

# font_import()
#loadfonts()

# Initialize showtext
#showtext_auto()
theme_set(
  theme_bw()  + 
    theme(
      plot.title    = element_text(size=20, family="NanumBarunGothicBold"),
      plot.subtitle = element_text(size=15, family="NanumBarunGothic"),
      text          = element_text(size=15, family="NanumBarunGothic")
          )
  
)

election_theme <-
  theme(
    plot.title = element_text( size = 10, face="bold" ),
    plot.subtitle = element_text( size = 8 ),
    plot.caption = element_text( size = 8 ),
    axis.text = element_text( size = 8 ),
    axis.title = element_text( size = 10 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 8 ),
    axis.text.y = element_text( size = 8 ),
    strip.text = element_text( size = 10 )
  )

"%ni%" <- Negate("%in%")

```

```{r}
#!/usr/bin/env Rscript
# -*- coding: utf-8 -*-
# Simple Election Data Loader
# Loads batch scraped data from data/ directory and formats it properly

# Load required libraries
library(tidyverse)
library(readr)
library(lubridate)

# Function to load city codes mapping
load_city_codes <- function() {
  city_codes <- read_delim("../config/city_codes.txt", 
                          delim = "|", 
                          comment = "#", 
                          col_names = c("code", "name_korean", "name_english"),
                          show_col_types = FALSE)
  return(city_codes)
}

# Function to parse batch directory name to extract timestamps
parse_batch_directory <- function(dir_name) {
  # Pattern: nec_data_electionId_date_time
  parts <- str_split(dir_name, "_")[[1]]
  if (length(parts) >= 4) {
    election_id <- parts[3]
    date_part <- parts[4]
    time_part <- parts[5]
    
    # Convert to datetime
    batch_timestamp <- ymd_hms(paste0(
      str_sub(date_part, 1, 4), "-",
      str_sub(date_part, 5, 6), "-", 
      str_sub(date_part, 7, 8), " ",
      str_sub(time_part, 1, 2), ":",
      str_sub(time_part, 3, 4), ":",
      str_sub(time_part, 5, 6)
    ))
    
    return(list(
      election_id = election_id,
      batch_timestamp = batch_timestamp
    ))
  }
  return(NULL)
}

# Function to parse CSV filename
parse_csv_filename <- function(filename) {
  # Pattern: citycode_cityname_date_time.csv
  basename_file <- str_remove(basename(filename), "\\.csv$")
  parts <- str_split(basename_file, "_")[[1]]
  
  if (length(parts) >= 3) {
    city_code <- parts[1]
    city_name <- parts[2]
    date_part <- parts[3]
    time_part <- parts[4]
    
    # Convert to datetime
    file_timestamp <- ymd_hms(paste0(
      str_sub(date_part, 1, 4), "-",
      str_sub(date_part, 5, 6), "-", 
      str_sub(date_part, 7, 8), " ",
      str_sub(time_part, 1, 2), ":",
      str_sub(time_part, 3, 4), ":",
      str_sub(time_part, 5, 6)
    ))
    
    return(list(
      city_code = city_code,
      city_name = city_name,
      file_timestamp = file_timestamp
    ))
  }
  return(NULL)
}

# Main function to load all election data
load_all_election_data <- function(data_dir = "../data") {
  cat("üöÄ Loading election data from", data_dir, "\n")
  
  # Load city codes
  city_codes <- load_city_codes()
  cat("üìã Loaded", nrow(city_codes), "city codes\n")
  
  # Get all batch directories
  batch_dirs <- list.dirs(data_dir, recursive = FALSE)
  cat("üìÅ Found", length(batch_dirs), "batch directories\n")
  
  all_data <- list()
  
  for (batch_dir in batch_dirs) {
    cat("üìÇ Processing", basename(batch_dir), "\n")
    
    # Parse batch directory info
    batch_info <- parse_batch_directory(basename(batch_dir))
    if (is.null(batch_info)) {
      cat("‚ö†Ô∏è  Could not parse batch directory:", basename(batch_dir), "\n")
      next
    }
    
    # Find all CSV files in this batch
    csv_files <- list.files(batch_dir, pattern = "\\.csv$", full.names = TRUE)
    
    for (csv_file in csv_files) {
      # Parse filename
      file_info <- parse_csv_filename(csv_file)
      if (is.null(file_info)) {
        cat("‚ö†Ô∏è  Could not parse filename:", basename(csv_file), "\n")
        next
      }
      
      # Read CSV data
      tryCatch({
        df <- read_csv(csv_file, locale = locale(encoding = "UTF-8"), show_col_types = FALSE)
        
        # Process based on whether it's Ï†ÑÏ≤¥ (total) or city-specific
        if (file_info$city_code == "0" && file_info$city_name == "Ï†ÑÏ≤¥") {
          # For Ï†ÑÏ≤¥ files: District becomes City, add District = "Ï†ÑÏ≤¥"
          df <- df %>%
            rename(City = District) %>%
            mutate(District = "Ï†ÑÏ≤¥")
        } else {
          # For city-specific files: add City column from city codes
          city_info <- city_codes %>% filter(code == file_info$city_code)
          if (nrow(city_info) > 0) {
            df <- df %>%
              mutate(City = city_info$name_korean[1])
          } else {
            # Fallback to the parsed city name from filename
            df <- df %>%
              mutate(City = file_info$city_name)
          }
        }
        
        # Add metadata columns
        df <- df %>%
          mutate(
            city_code = file_info$city_code,
            batch_timestamp = batch_info$batch_timestamp,
            file_timestamp = file_info$file_timestamp,
            election_id = batch_info$election_id
          )
        
        # Reorder columns to put metadata first
        df <- df %>%
          select(election_id, city_code, City, District, batch_timestamp, file_timestamp, everything())
        
        all_data[[length(all_data) + 1]] <- df
        
      }, error = function(e) {
        cat("‚ùå Error reading", basename(csv_file), ":", e$message, "\n")
      })
    }
  }
  
  # Combine all data
  if (length(all_data) > 0) {
    combined_data <- bind_rows(all_data)
    cat("‚úÖ Successfully loaded", nrow(combined_data), "rows from", length(all_data), "files\n")
    cat("üìä Data range:", min(combined_data$batch_timestamp), "to", max(combined_data$batch_timestamp), "\n")
    cat("üèôÔ∏è  Cities:", length(unique(combined_data$City)), "\n")
    
    return(combined_data)
  } else {
    cat("‚ùå No data loaded\n")
    return(NULL)
  }
}

# Example usage:
# Load all data
# election_data <- load_all_election_data()

# View structure
# glimpse(election_data)

# Check unique cities
# election_data %>% distinct(City, city_code) %>% arrange(city_code)

# Check data types by city
# election_data %>% count(City, District) %>% arrange(City)
```

```{r}
# Load all data
election_data <- load_all_election_data()

# View the structure
glimpse(election_data)

# Check what cities we have
election_data %>% distinct(City, city_code) %>% arrange(city_code)

# See the data types (total vs district-level)
election_data %>% count(City, District) %>% arrange(City)

```

```{r}
election_data$City %>% unique()
```

ÌõÑÎ≥¥ÏûêÎ≥Ñ ÎìùÌëúÏàò Ìï©Í≥ÑÏôÄ Î¨¥Ìö®Ìà¨ÌëúÏàò, Í∏∞Í∂åÏûêÏàòÍ∞Ä ÎΩëÌûàÏßÄ ÏïäÏïòÎã§.........ÌïòÏßÄÎßå Í≥ÑÏÇ∞ Í∞ÄÎä•ÌïòÎã§

```{r}
election_data %>% colnames()
```
# ÌõÑÎ≥¥Î≥Ñ ÎìùÌëúÏàò, ÎìùÌëúÏú® Ï∂îÏù¥

```{r}
election_data %>%
  dplyr::filter( city_code == 0 ) %>%
  group_by( city_code ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Votes") ) %>%
  dplyr::select( -Invalid_Votes, -Total_Votes ) %>%
  pivot_longer( cols = ends_with("_Votes"), names_to = "candidate", values_to = "Votes" ) %>%
  mutate(
    candidate = gsub("_Votes", "", candidate ),
    candidate2 = case_when(
      grepl("Ïù¥Ïû¨Î™Ö", candidate) ~ "Ïù¥Ïû¨Î™Ö",
      grepl("ÍπÄÎ¨∏Ïàò", candidate) ~ "ÍπÄÎ¨∏Ïàò",
      grepl("Ïù¥Ï§ÄÏÑù", candidate) ~ "Ïù¥Ï§ÄÏÑù",
      grepl("Í∂åÏòÅÍµ≠", candidate) ~ "Í∂åÏòÅÍµ≠",
      TRUE ~ "Í∏∞ÌÉÄ"
    ),
    candidate2 = factor( candidate2, levels = c("Ïù¥Ïû¨Î™Ö", "ÍπÄÎ¨∏Ïàò", "Ïù¥Ï§ÄÏÑù", "Í∂åÏòÅÍµ≠", "Í∏∞ÌÉÄ")),
    City = factor( City, levels = c("ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
  ) %>%
  dplyr::filter( candidate2 != "Í∏∞ÌÉÄ", batch_timestamp != max(batch_timestamp) ) %>%
  ggplot( aes( x = file_timestamp, y = Votes/10000, colour = candidate2 ) ) +
  geom_line() +
  facet_wrap( City ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::comma ) +
  scale_colour_manual(
    values = c(
      "Ïù¥Ïû¨Î™Ö" = "#1e4d9b",
      "ÍπÄÎ¨∏Ïàò" = "#e61e2b",
      "Ïù¥Ï§ÄÏÑù" = "#ea5504",
      "Í∂åÏòÅÍµ≠" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "Í∞úÌëúÏãú ÌõÑÎ≥¥Î≥Ñ ÎìùÌëúÏàò Î≥ÄÌôî",
    colour = "ÌõÑÎ≥¥",
    y = "ÎßåÌëú"
  )

```
```{r}
election_data %>%
  dplyr::filter( city_code == 0 ) %>%
  group_by( city_code ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Percentage") ) %>%
  pivot_longer( cols = ends_with("_Percentage"), names_to = "candidate", values_to = "Percent" ) %>%
  mutate(
    candidate = gsub("_Votes", "", candidate ),
    candidate2 = case_when(
      grepl("Ïù¥Ïû¨Î™Ö", candidate) ~ "Ïù¥Ïû¨Î™Ö",
      grepl("ÍπÄÎ¨∏Ïàò", candidate) ~ "ÍπÄÎ¨∏Ïàò",
      grepl("Ïù¥Ï§ÄÏÑù", candidate) ~ "Ïù¥Ï§ÄÏÑù",
      grepl("Í∂åÏòÅÍµ≠", candidate) ~ "Í∂åÏòÅÍµ≠",
      TRUE ~ "Í∏∞ÌÉÄ"
    ),
    candidate2 = factor( candidate2, levels = c("Ïù¥Ïû¨Î™Ö", "ÍπÄÎ¨∏Ïàò", "Ïù¥Ï§ÄÏÑù", "Í∂åÏòÅÍµ≠", "Í∏∞ÌÉÄ")),
    City = factor( City, levels = c("ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
    
  ) %>%
  dplyr::filter( candidate2 != "Í∏∞ÌÉÄ", batch_timestamp != max(batch_timestamp) ) %>%
  ggplot( aes( x = file_timestamp, y = Percent/100, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( City ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::percent, expand = expansion( mult = c(0, 0.05 )) ) +
  scale_colour_manual(
    values = c(
      "Ïù¥Ïû¨Î™Ö" = "#1e4d9b",
      "ÍπÄÎ¨∏Ïàò" = "#e61e2b",
      "Ïù¥Ï§ÄÏÑù" = "#ea5504",
      "Í∂åÏòÅÍµ≠" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "Í∞úÌëúÏãú ÌõÑÎ≥¥Î≥Ñ ÎìùÌëúÏú® Î≥ÄÌôî",
    colour = "ÌõÑÎ≥¥",
#    y = "ÎßåÌëú"
  )

```

# ÏÑ†Í±∞Ïù∏Ïàò, Ìà¨ÌëúÏàò Ï†ïÎ¶¨

`Eligible_Voters`Îäî ÏÑ†Í±∞Ïù∏Ïàò. `Total_Votes`Îäî Ìà¨ÌëúÏàò.

```{r}
election_data %>%
  dplyr::filter( batch_timestamp == max(batch_timestamp) ) %>%
  dplyr::select( !ends_with("_Percentage" ) ) %>%
  dplyr::select( !ends_with("_timestamp") ) %>%
  mutate(
    Í∏∞Í∂åÏûêÏàò = Eligible_Voters - Total_Votes
  )
```

Í∑∏Îü∞Îç∞ Ïù¥Í≤å Ï≤òÏùåÏóêÎäî ÏÑ†Í±∞Ïù∏ÏàòÎûë Ìà¨ÌëúÏàò ÏûêÏ≤¥Í∞Ä Î≥ÄÌï¥Î≤ÑÎ¶¨Îäî Î¨∏Ï†úÍ∞Ä ÏûàÎã§.

```{r}
election_data %>%
  dplyr::filter( city_code == 0 ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  group_by(
    election_id, city_code, City, District
  ) %>%
  dplyr::select( file_timestamp, City, Total_Votes, Eligible_Voters ) %>%
  mutate(
    City = factor( City, levels = c("ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ"))
  ) %>% 
  pivot_longer( cols = contains("_Vote"), names_to = "ÏπºÎüº", values_to = "n" ) %>%
  ggplot( aes( x = file_timestamp, y = n, colour = City ) ) +
  geom_line() +
  scale_y_continuous( label = scales::comma ) +
  facet_wrap( . ~ ÏπºÎüº ) +
  theme(
    text = element_text( size = 15 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1 )
  )
```
Í∞úÌëúÏú®Í≥º Í∏∞Í∂åÌëúÎ•º Îã§Ïãú Í≥ÑÏÇ∞ÌïòÍ∏∞ ÏúÑÌï¥ÏÑúÎùºÎ©¥ Ïù¥ ÏÑ†Í±∞Ïù∏ÏàòÏôÄ Ìà¨ÌëúÏàòÎ•º ÏàòÏ†ïÌï¥ÏïºÌïúÎã§.


# Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "Ï†ÑÏ≤¥", "Ï†ÑÏ≤¥", City ),
    District2 = ifelse( District == "Ï†ÑÏ≤¥", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("Ï†ÑÏ≤¥", "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ÏÑ†Í±∞Ïù∏Ïàò` = max( Eligible_Voters ),
    `Ìà¨ÌëúÏàò` = max( Total_Votes ),
    Abstentions = ÏÑ†Í±∞Ïù∏Ïàò - Total_Votes,
    Invalid_Votes = Total_Votes 
      - Î¨¥ÏÜåÏÜçÏÜ°ÏßÑÌò∏_Votes 
      - ÎØºÏ£ºÎÖ∏ÎèôÎãπÍ∂åÏòÅÍµ≠_Votes 
      - Í∞úÌòÅÏã†ÎãπÏù¥Ï§ÄÏÑù_Votes 
      - Íµ≠ÎØºÏùòÌûòÍπÄÎ¨∏Ïàò_Votes
      - ÎçîÎ∂àÏñ¥ÎØºÏ£ºÎãπÏù¥Ïû¨Î™Ö_Votes,
    Counting_Rate = Total_Votes / Ìà¨ÌëúÏàò,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  write_tsv("../processed/Í∞úÌëúÏßÑÌñâÏÉÅÌô©.tsv")
```


# Í∞úÌëúÏú® Ï∂îÏù¥

## Ï†ÑÏ≤¥ (Í¥ëÏó≠Î≥Ñ)

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "Ï†ÑÏ≤¥", "Ï†ÑÏ≤¥", City ),
    District2 = ifelse( District == "Ï†ÑÏ≤¥", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("Ï†ÑÏ≤¥", "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ÏÑ†Í±∞Ïù∏Ïàò` = max( Eligible_Voters ),
    `Ìà¨ÌëúÏàò` = max( Total_Votes ),
    Abstentions = ÏÑ†Í±∞Ïù∏Ïàò - Total_Votes,
    Invalid_Votes = Total_Votes 
      - Î¨¥ÏÜåÏÜçÏÜ°ÏßÑÌò∏_Votes 
      - ÎØºÏ£ºÎÖ∏ÎèôÎãπÍ∂åÏòÅÍµ≠_Votes 
      - Í∞úÌòÅÏã†ÎãπÏù¥Ï§ÄÏÑù_Votes 
      - Íµ≠ÎØºÏùòÌûòÍπÄÎ¨∏Ïàò_Votes
      - ÎçîÎ∂àÏñ¥ÎØºÏ£ºÎãπÏù¥Ïû¨Î™Ö_Votes,
    Counting_Rate = Total_Votes / Ìà¨ÌëúÏàò,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "Ï†ÑÏ≤¥" ) %>%
  mutate(
    District = factor( District, levels = c( "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  ) %>%
  ggplot( aes( x = file_timestamp, y = Counting_Rate, colour = District ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( expand = expansion( mult = c(0, 0) ), label = scales::percent ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    x = "ÌïúÍµ≠ ÏãúÍ∞Å",
    y = "Í∞úÌëúÏú®(%)"
  )
```

## ÏÑúÏö∏ÌäπÎ≥ÑÏãú ÏÇ¨Î°Ä

```{r}
election_data %>%
  dplyr::filter( city_code == 0 ) %>%
  group_by( city_code ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Percentage") ) %>%
  pivot_longer( cols = ends_with("_Percentage"), names_to = "candidate", values_to = "Percent" ) %>%
  mutate(
    candidate = gsub("_Votes", "", candidate ),
    candidate2 = case_when(
      grepl("Ïù¥Ïû¨Î™Ö", candidate) ~ "Ïù¥Ïû¨Î™Ö",
      grepl("ÍπÄÎ¨∏Ïàò", candidate) ~ "ÍπÄÎ¨∏Ïàò",
      grepl("Ïù¥Ï§ÄÏÑù", candidate) ~ "Ïù¥Ï§ÄÏÑù",
      grepl("Í∂åÏòÅÍµ≠", candidate) ~ "Í∂åÏòÅÍµ≠",
      TRUE ~ "Í∏∞ÌÉÄ"
    ),
    candidate2 = factor( candidate2, levels = c("Ïù¥Ïû¨Î™Ö", "ÍπÄÎ¨∏Ïàò", "Ïù¥Ï§ÄÏÑù", "Í∂åÏòÅÍµ≠", "Í∏∞ÌÉÄ")),
    City = factor( City, levels = c("ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
    
  ) %>%
  dplyr::filter( candidate2 != "Í∏∞ÌÉÄ", batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ÏÑúÏö∏ÌäπÎ≥ÑÏãú" ) %>%
  ggplot( aes( x = file_timestamp, y = Percent/100, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( City ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::percent, expand = expansion( mult = c(0, 0.05 )) ) +
  scale_colour_manual(
    values = c(
      "Ïù¥Ïû¨Î™Ö" = "#1e4d9b",
      "ÍπÄÎ¨∏Ïàò" = "#e61e2b",
      "Ïù¥Ï§ÄÏÑù" = "#ea5504",
      "Í∂åÏòÅÍµ≠" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "Í∞úÌëúÏãú ÌõÑÎ≥¥Î≥Ñ ÎìùÌëúÏú® Î≥ÄÌôî",
    colour = "ÌõÑÎ≥¥",
    y = "ÎìùÌëúÏú®(%)"
  )

```


```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "Ï†ÑÏ≤¥", "Ï†ÑÏ≤¥", City ),
    District2 = ifelse( District == "Ï†ÑÏ≤¥", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("Ï†ÑÏ≤¥", "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ÏÑ†Í±∞Ïù∏Ïàò` = max( Eligible_Voters ),
    `Ìà¨ÌëúÏàò` = max( Total_Votes ),
    Abstentions = ÏÑ†Í±∞Ïù∏Ïàò - Total_Votes,
    Invalid_Votes = Total_Votes 
      - Î¨¥ÏÜåÏÜçÏÜ°ÏßÑÌò∏_Votes 
      - ÎØºÏ£ºÎÖ∏ÎèôÎãπÍ∂åÏòÅÍµ≠_Votes 
      - Í∞úÌòÅÏã†ÎãπÏù¥Ï§ÄÏÑù_Votes 
      - Íµ≠ÎØºÏùòÌûòÍπÄÎ¨∏Ïàò_Votes
      - ÎçîÎ∂àÏñ¥ÎØºÏ£ºÎãπÏù¥Ïû¨Î™Ö_Votes,
    Counting_Rate = Total_Votes / Ìà¨ÌëúÏàò,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ÏÑúÏö∏ÌäπÎ≥ÑÏãú" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  # ) %>%
  ggplot( aes( x = file_timestamp, y = Counting_Rate, colour = District ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( expand = expansion( mult = c(0, 0) ), label = scales::percent ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "Í∞úÌëúÎãπÏãú Íµ¨Î≥Ñ Í∞úÌëúÏú®",
    subtitle = "ÏÑúÏö∏ÌäπÎ≥ÑÏãú",
    x = "ÌïúÍµ≠ ÏãúÍ∞Å",
    y = "Í∞úÌëúÏú®(%)",
    caption = "Í¥ÄÏô∏Ìà¨ÌëúÎäî ÎßàÏßÄÎßâÏóê Ï∂îÍ∞ÄÎêú Í≤ÉÏúºÎ°ú Î≥¥ÏûÑ"
  )
```

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "Ï†ÑÏ≤¥", "Ï†ÑÏ≤¥", City ),
    District2 = ifelse( District == "Ï†ÑÏ≤¥", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("Ï†ÑÏ≤¥", "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ÏÑ†Í±∞Ïù∏Ïàò` = max( Eligible_Voters ),
    `Ìà¨ÌëúÏàò` = max( Total_Votes ),
    Abstentions = ÏÑ†Í±∞Ïù∏Ïàò - Total_Votes,
    Invalid_Votes = Total_Votes 
      - Î¨¥ÏÜåÏÜçÏÜ°ÏßÑÌò∏_Votes 
      - ÎØºÏ£ºÎÖ∏ÎèôÎãπÍ∂åÏòÅÍµ≠_Votes 
      - Í∞úÌòÅÏã†ÎãπÏù¥Ï§ÄÏÑù_Votes 
      - Íµ≠ÎØºÏùòÌûòÍπÄÎ¨∏Ïàò_Votes
      - ÎçîÎ∂àÏñ¥ÎØºÏ£ºÎãπÏù¥Ïû¨Î™Ö_Votes,
    Counting_Rate = Total_Votes / Ìà¨ÌëúÏàò,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ÏÑúÏö∏ÌäπÎ≥ÑÏãú" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  # ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Percentage") ) %>%
  pivot_longer( 
    cols = ends_with("_Percentage"), 
    names_to = "candidate", 
    values_to = "Percent"
  ) %>%
  mutate(
    candidate2 = case_when(
      grepl("Ïù¥Ïû¨Î™Ö", candidate) ~ "Ïù¥Ïû¨Î™Ö",
      grepl("ÍπÄÎ¨∏Ïàò", candidate) ~ "ÍπÄÎ¨∏Ïàò",
      grepl("Ïù¥Ï§ÄÏÑù", candidate) ~ "Ïù¥Ï§ÄÏÑù",
      grepl("Í∂åÏòÅÍµ≠", candidate) ~ "Í∂åÏòÅÍµ≠",
      TRUE ~ "Í∏∞ÌÉÄ"
    ),
    candidate2 = factor( candidate2, levels = c("Ïù¥Ïû¨Î™Ö", "ÍπÄÎ¨∏Ïàò", "Ïù¥Ï§ÄÏÑù", "Í∂åÏòÅÍµ≠", "Í∏∞ÌÉÄ"))
  ) %>%
  ggplot( aes( x = file_timestamp, y = Percent/100, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( District ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::percent, expand = expansion( mult = c(0, 0.05 )) ) +
  scale_colour_manual(
    values = c(
      "Ïù¥Ïû¨Î™Ö" = "#1e4d9b",
      "ÍπÄÎ¨∏Ïàò" = "#e61e2b",
      "Ïù¥Ï§ÄÏÑù" = "#ea5504",
      "Í∂åÏòÅÍµ≠" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "Í∞úÌëúÏãú ÌõÑÎ≥¥Î≥Ñ ÎìùÌëúÏú® Î≥ÄÌôî",
    subtitle = "ÏÑúÏö∏ÌäπÎ≥ÑÏãú",
    colour = "ÌõÑÎ≥¥",
    y = "ÎìùÌëúÏú®(%)"
  )
```

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "Ï†ÑÏ≤¥", "Ï†ÑÏ≤¥", City ),
    District2 = ifelse( District == "Ï†ÑÏ≤¥", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("Ï†ÑÏ≤¥", "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ÏÑ†Í±∞Ïù∏Ïàò` = max( Eligible_Voters ),
    `Ìà¨ÌëúÏàò` = max( Total_Votes ),
    Abstentions = ÏÑ†Í±∞Ïù∏Ïàò - Total_Votes,
    Invalid_Votes = Total_Votes 
      - Î¨¥ÏÜåÏÜçÏÜ°ÏßÑÌò∏_Votes 
      - ÎØºÏ£ºÎÖ∏ÎèôÎãπÍ∂åÏòÅÍµ≠_Votes 
      - Í∞úÌòÅÏã†ÎãπÏù¥Ï§ÄÏÑù_Votes 
      - Íµ≠ÎØºÏùòÌûòÍπÄÎ¨∏Ïàò_Votes
      - ÎçîÎ∂àÏñ¥ÎØºÏ£ºÎãπÏù¥Ïû¨Î™Ö_Votes,
    Counting_Rate = Total_Votes / Ìà¨ÌëúÏàò,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "ÏÑúÏö∏ÌäπÎ≥ÑÏãú" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  # ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Votes") ) %>%
  pivot_longer( 
    cols = ends_with("_Votes"), 
    names_to = "candidate", 
    values_to = "Votes"
  ) %>%
  mutate(
    candidate2 = case_when(
      grepl("Ïù¥Ïû¨Î™Ö", candidate) ~ "Ïù¥Ïû¨Î™Ö",
      grepl("ÍπÄÎ¨∏Ïàò", candidate) ~ "ÍπÄÎ¨∏Ïàò",
      grepl("Ïù¥Ï§ÄÏÑù", candidate) ~ "Ïù¥Ï§ÄÏÑù",
      grepl("Í∂åÏòÅÍµ≠", candidate) ~ "Í∂åÏòÅÍµ≠",
      TRUE ~ "Í∏∞ÌÉÄ"
    ),
    candidate2 = factor( candidate2, levels = c("Ïù¥Ïû¨Î™Ö", "ÍπÄÎ¨∏Ïàò", "Ïù¥Ï§ÄÏÑù", "Í∂åÏòÅÍµ≠", "Í∏∞ÌÉÄ"))
  ) %>%
  dplyr::filter( candidate2 %ni% c("Í∏∞ÌÉÄ"), !is.na( candidate2) ) %>%
  ggplot( aes( x = file_timestamp, y = Votes, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( District ~ . ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( 
    label = scales::comma, 
    expand = expansion( mult = c(0, 0.05 )) 
  ) +
  scale_colour_manual(
    values = c(
      "Ïù¥Ïû¨Î™Ö" = "#1e4d9b",
      "ÍπÄÎ¨∏Ïàò" = "#e61e2b",
      "Ïù¥Ï§ÄÏÑù" = "#ea5504",
      "Í∂åÏòÅÍµ≠" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "Í∞úÌëú ÎãπÏãú ÌõÑÎ≥¥Î≥Ñ ÎìùÌëúÏàò Î≥ÄÌôî",
    subtitle = "ÏÑúÏö∏ÌäπÎ≥ÑÏãú",
    colour = "ÌõÑÎ≥¥",
    y = "ÎìùÌëúÏàò"
  )
```
## Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú ÏÇ¨Î°Ä

```{r}
election_data %>%
  dplyr::filter( city_code == 0 ) %>%
  group_by( city_code ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Percentage") ) %>%
  pivot_longer( cols = ends_with("_Percentage"), names_to = "candidate", values_to = "Percent" ) %>%
  mutate(
    candidate = gsub("_Votes", "", candidate ),
    candidate2 = case_when(
      grepl("Ïù¥Ïû¨Î™Ö", candidate) ~ "Ïù¥Ïû¨Î™Ö",
      grepl("ÍπÄÎ¨∏Ïàò", candidate) ~ "ÍπÄÎ¨∏Ïàò",
      grepl("Ïù¥Ï§ÄÏÑù", candidate) ~ "Ïù¥Ï§ÄÏÑù",
      grepl("Í∂åÏòÅÍµ≠", candidate) ~ "Í∂åÏòÅÍµ≠",
      TRUE ~ "Í∏∞ÌÉÄ"
    ),
    candidate2 = factor( candidate2, levels = c("Ïù¥Ïû¨Î™Ö", "ÍπÄÎ¨∏Ïàò", "Ïù¥Ï§ÄÏÑù", "Í∂åÏòÅÍµ≠", "Í∏∞ÌÉÄ")),
    City = factor( City, levels = c("ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
    
  ) %>%
  dplyr::filter( candidate2 != "Í∏∞ÌÉÄ", batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú" ) %>%
  ggplot( aes( x = file_timestamp, y = Percent/100, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( City ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::percent, expand = expansion( mult = c(0, 0.05 )) ) +
  scale_colour_manual(
    values = c(
      "Ïù¥Ïû¨Î™Ö" = "#1e4d9b",
      "ÍπÄÎ¨∏Ïàò" = "#e61e2b",
      "Ïù¥Ï§ÄÏÑù" = "#ea5504",
      "Í∂åÏòÅÍµ≠" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "Í∞úÌëúÏãú ÌõÑÎ≥¥Î≥Ñ ÎìùÌëúÏú® Î≥ÄÌôî",
    colour = "ÌõÑÎ≥¥",
#    y = "ÎßåÌëú"
  )

```


```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "Ï†ÑÏ≤¥", "Ï†ÑÏ≤¥", City ),
    District2 = ifelse( District == "Ï†ÑÏ≤¥", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("Ï†ÑÏ≤¥", "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ÏÑ†Í±∞Ïù∏Ïàò` = max( Eligible_Voters ),
    `Ìà¨ÌëúÏàò` = max( Total_Votes ),
    Abstentions = ÏÑ†Í±∞Ïù∏Ïàò - Total_Votes,
    Invalid_Votes = Total_Votes 
      - Î¨¥ÏÜåÏÜçÏÜ°ÏßÑÌò∏_Votes 
      - ÎØºÏ£ºÎÖ∏ÎèôÎãπÍ∂åÏòÅÍµ≠_Votes 
      - Í∞úÌòÅÏã†ÎãπÏù¥Ï§ÄÏÑù_Votes 
      - Íµ≠ÎØºÏùòÌûòÍπÄÎ¨∏Ïàò_Votes
      - ÎçîÎ∂àÏñ¥ÎØºÏ£ºÎãπÏù¥Ïû¨Î™Ö_Votes,
    Counting_Rate = Total_Votes / Ìà¨ÌëúÏàò,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  # ) %>%
  ggplot( aes( x = file_timestamp, y = Counting_Rate, colour = District ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( expand = expansion( mult = c(0, 0) ), label = scales::percent ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    x = "ÌïúÍµ≠ ÏãúÍ∞Å",
    y = "Í∞úÌëúÏú®(%)"
  )
```

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "Ï†ÑÏ≤¥", "Ï†ÑÏ≤¥", City ),
    District2 = ifelse( District == "Ï†ÑÏ≤¥", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("Ï†ÑÏ≤¥", "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ÏÑ†Í±∞Ïù∏Ïàò` = max( Eligible_Voters ),
    `Ìà¨ÌëúÏàò` = max( Total_Votes ),
    Abstentions = ÏÑ†Í±∞Ïù∏Ïàò - Total_Votes,
    Invalid_Votes = Total_Votes 
      - Î¨¥ÏÜåÏÜçÏÜ°ÏßÑÌò∏_Votes 
      - ÎØºÏ£ºÎÖ∏ÎèôÎãπÍ∂åÏòÅÍµ≠_Votes 
      - Í∞úÌòÅÏã†ÎãπÏù¥Ï§ÄÏÑù_Votes 
      - Íµ≠ÎØºÏùòÌûòÍπÄÎ¨∏Ïàò_Votes
      - ÎçîÎ∂àÏñ¥ÎØºÏ£ºÎãπÏù¥Ïû¨Î™Ö_Votes,
    Counting_Rate = Total_Votes / Ìà¨ÌëúÏàò,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  # ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Percentage") ) %>%
  pivot_longer( 
    cols = ends_with("_Percentage"), 
    names_to = "candidate", 
    values_to = "Percent"
  ) %>%
  mutate(
    candidate2 = case_when(
      grepl("Ïù¥Ïû¨Î™Ö", candidate) ~ "Ïù¥Ïû¨Î™Ö",
      grepl("ÍπÄÎ¨∏Ïàò", candidate) ~ "ÍπÄÎ¨∏Ïàò",
      grepl("Ïù¥Ï§ÄÏÑù", candidate) ~ "Ïù¥Ï§ÄÏÑù",
      grepl("Í∂åÏòÅÍµ≠", candidate) ~ "Í∂åÏòÅÍµ≠",
      TRUE ~ "Í∏∞ÌÉÄ"
    ),
    candidate2 = factor( candidate2, levels = c("Ïù¥Ïû¨Î™Ö", "ÍπÄÎ¨∏Ïàò", "Ïù¥Ï§ÄÏÑù", "Í∂åÏòÅÍµ≠", "Í∏∞ÌÉÄ"))
  ) %>%
  ggplot( aes( x = file_timestamp, y = Percent/100, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( District ~ ., scale = "free_y" ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( label = scales::percent, expand = expansion( mult = c(0, 0.05 )) ) +
  scale_colour_manual(
    values = c(
      "Ïù¥Ïû¨Î™Ö" = "#1e4d9b",
      "ÍπÄÎ¨∏Ïàò" = "#e61e2b",
      "Ïù¥Ï§ÄÏÑù" = "#ea5504",
      "Í∂åÏòÅÍµ≠" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "Í∞úÌëúÏãú ÌõÑÎ≥¥Î≥Ñ ÎìùÌëúÏú® Î≥ÄÌôî",
    subtitle = "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú",
    colour = "ÌõÑÎ≥¥",
    y = "ÎìùÌëúÏú®(%)"
  )
```

```{r}
election_data %>%
  mutate(
    City2 = ifelse( District == "Ï†ÑÏ≤¥", "Ï†ÑÏ≤¥", City ),
    District2 = ifelse( District == "Ï†ÑÏ≤¥", City, District ),
    City = City2,
    District = District2,
    City = factor( City, levels = c("Ï†ÑÏ≤¥", "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  )  %>%
  group_by( City, District ) %>%
  mutate(
    `ÏÑ†Í±∞Ïù∏Ïàò` = max( Eligible_Voters ),
    `Ìà¨ÌëúÏàò` = max( Total_Votes ),
    Abstentions = ÏÑ†Í±∞Ïù∏Ïàò - Total_Votes,
    Invalid_Votes = Total_Votes 
      - Î¨¥ÏÜåÏÜçÏÜ°ÏßÑÌò∏_Votes 
      - ÎØºÏ£ºÎÖ∏ÎèôÎãπÍ∂åÏòÅÍµ≠_Votes 
      - Í∞úÌòÅÏã†ÎãπÏù¥Ï§ÄÏÑù_Votes 
      - Íµ≠ÎØºÏùòÌûòÍπÄÎ¨∏Ïàò_Votes
      - ÎçîÎ∂àÏñ¥ÎØºÏ£ºÎãπÏù¥Ïû¨Î™Ö_Votes,
    Counting_Rate = Total_Votes / Ìà¨ÌëúÏàò,
    # Use force_tz to treat the timestamp AS EDT (not convert from unknown to EDT)
    file_timestamp = force_tz(file_timestamp, tzone = "America/New_York"),
    file_timestamp = with_tz(file_timestamp, tzone = "Asia/Seoul")
#    batch_timestamp = lubridate::with_tz(batch_timestamp, "Asia/Seoul")    
  ) %>%
  dplyr::filter( batch_timestamp != max(batch_timestamp) ) %>%
  dplyr::filter( City == "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú" ) %>%
  # mutate(
  #   District = factor( District, levels = c( "ÏÑúÏö∏ÌäπÎ≥ÑÏãú", "Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú", "ÎåÄÍµ¨Í¥ëÏó≠Ïãú", "Ïù∏Ï≤úÍ¥ëÏó≠Ïãú", "Í¥ëÏ£ºÍ¥ëÏó≠Ïãú", "ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú", "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú", "ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú", "Í≤ΩÍ∏∞ÎèÑ", "Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï∂©Ï≤≠Î∂ÅÎèÑ", "Ï∂©Ï≤≠ÎÇ®ÎèÑ", "Ï†ÑÎ∂ÅÌäπÎ≥ÑÏûêÏπòÎèÑ", "Ï†ÑÎùºÎÇ®ÎèÑ", "Í≤ΩÏÉÅÎ∂ÅÎèÑ", "Í≤ΩÏÉÅÎÇ®ÎèÑ", "Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ")),
  # ) %>%
  dplyr::select( batch_timestamp, file_timestamp, City, ends_with("_Votes") ) %>%
  pivot_longer( 
    cols = ends_with("_Votes"), 
    names_to = "candidate", 
    values_to = "Votes"
  ) %>%
  mutate(
    candidate2 = case_when(
      grepl("Ïù¥Ïû¨Î™Ö", candidate) ~ "Ïù¥Ïû¨Î™Ö",
      grepl("ÍπÄÎ¨∏Ïàò", candidate) ~ "ÍπÄÎ¨∏Ïàò",
      grepl("Ïù¥Ï§ÄÏÑù", candidate) ~ "Ïù¥Ï§ÄÏÑù",
      grepl("Í∂åÏòÅÍµ≠", candidate) ~ "Í∂åÏòÅÍµ≠",
      TRUE ~ "Í∏∞ÌÉÄ"
    ),
    candidate2 = factor( candidate2, levels = c("Ïù¥Ïû¨Î™Ö", "ÍπÄÎ¨∏Ïàò", "Ïù¥Ï§ÄÏÑù", "Í∂åÏòÅÍµ≠", "Í∏∞ÌÉÄ"))
  ) %>%
  dplyr::filter( candidate2 %ni% c("Í∏∞ÌÉÄ"), !is.na( candidate2) ) %>%
  ggplot( aes( x = file_timestamp, y = Votes, colour = candidate2 ) ) +
  geom_line() +
  expand_limits( y = 0 ) +
  facet_wrap( District ~ . ) +
  # scale_x_datetime(
  #   date_breaks = "1 hour",
  #   date_labels = "%m/%d\n%H:%M",  # Date on top line, time below
  #   expand = c(0.01, 0.01)
  # ) +
  scale_x_datetime( date_breaks = "1 hour", date_labels = "%H:%M" ) +
  scale_y_continuous( 
    label = scales::comma, 
    expand = expansion( mult = c(0, 0.05 )) 
  ) +
  scale_colour_manual(
    values = c(
      "Ïù¥Ïû¨Î™Ö" = "#1e4d9b",
      "ÍπÄÎ¨∏Ïàò" = "#e61e2b",
      "Ïù¥Ï§ÄÏÑù" = "#ea5504",
      "Í∂åÏòÅÍµ≠" = "#f7cc46"
    )
  ) +
  theme(
    text = element_text( size = 12 ),
    axis.text.y = element_text( size = 6 ),
    axis.text.x = element_text( angle = 45, hjust = 1, size = 6 ),
    legend.text = element_text( size = 10 ),
    strip.text = element_text( size = 10 ),
    axis.title.x = element_blank()
  ) +
  labs(
    title = "Í∞úÌëú ÎãπÏãú ÌõÑÎ≥¥Î≥Ñ ÎìùÌëúÏàò Î≥ÄÌôî",
    subtitle = "Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú",
    colour = "ÌõÑÎ≥¥",
    y = "ÎìùÌëúÏàò"
  )
```